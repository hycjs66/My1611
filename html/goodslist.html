<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../css/Reset.css">
    <link rel="stylesheet" href="../css/toubu.css">
    <style>
        #content {
            margin: 10px auto;
            width: 70%;
        }

        #content .tr {
            float: left;
            width: 250px;
            height: 160px;
            margin-left: 4px;
            margin-top: 4px;
            box-shadow: 2px 2px 2px #cdcdcd;
        }

        #content .tr img {
            height: 100px;
            width: 248px;
        }

        #content .tr p {
            height: 30px;
            width: 250px;
        }

        #content .tr .buy {
            background-color: black;
            color: #cdcdcd;
        }

        #userInfo {
            height: 30px;
            width: 150px;
            color: #000000;
            /* text-align: center; */
            line-height: 30px;
        }

        #shoppingInfo {
            height: 30px;
            width: 100px;
            color: black;
            text-align: center;
            line-height: 30px;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <!-- 头部 -->
    <div class="title">
        <div class="center">
            <div><a href="../index.html"><img src="../images/1.jpg" style="width: 55px; height: 55px;" title="我是logo"></a></div>
            <ul class="daohang">
                <li class="dh_1">
                    <a href="#" class="dh_11">礼物分类</a>
                    <ul class="dh_2">
                        <li><a href="#">少女心饰</a></li>
                        <li><a href="#">萌萌美物</a></li>
                        <li><a href="#">为爱停留</a></li>
                        <li><a href="#">潮流时尚</a></li>
                        <li><a href="#">科技达人</a></li>
                        <li><a href="#">幸福烙印</a></li>
                    </ul>
                </li>
                <li class="top_1">
                    <a href="#" class="top_11">送礼导航</a>
                    <ul class="top_2">
                        <li><a href="#">公主女票 </a></li>
                        <li><a href="#">欧巴男票</a></li>
                        <li><a href="#">潮爸辣妈</a></li>
                        <li><a href="">兄弟闺蜜</a> </li>
                        <li><a href="#">熊孩子</a></li>
                        <li><a href="#">生意伙伴</a></li>
                    </ul>
                </li>
                <li><a>创意礼物</a></li>
                <li><a>新品上架</a></li>
                <li><a>愚人节礼物</a></li>
            </ul>
            <div class="dv">
                <img src="../images/7.png" alt="" class="img_1">
                <div class="dv_1">
                    <div id="userInfo" style="margin-left: 40px;">
                        <!-- leson 退出 -->
                        <!-- 请登录 -->
                    </div>
                </div>
                <div class="zc">
                    <img src="../images/8.png" alt="" class="img_2">
                    <div id="shoppingInfo">
                        <!-- 登录人的购物车相关信息 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- goodinfo -->
    <div id="content">
        <!-- <div class="tr">
            <img src="images/1.jpg">
            <p>
                <span>商品名称</span>
            </p>
            <p>
                <span>999999</span>
                <span>999999</span>
                <span>立即购买</span>
            </p>
        </div> -->
    </div>
</body>
<script src="../js/cookie.js"></script>
<script src="../js/jquery-1.11.3.js"></script>
<script>
    var content = document.getElementById("content"); //元素生成目的地
    var userInfoDiv = document.getElementById("userInfo");
    var shoppingInfoDiv = document.getElementById("shoppingInfo");

    //进行判断
    var loginId = getCookie("loginId");
    if (loginId) {
        var loginName = getCookie("loginName");
        userInfoDiv.innerHTML = `<span>${loginName}</span><span onclick="userExist()">退出</span>`;
        showNum(); //显示已经登录用户的购买情况
    } else {
        userInfoDiv.innerHTML = `<span onclick="gotoLogin()">点击登录</span>`;
    }



    $.ajax({
        type: "get",
        url: "../php/goodslist.php", //java aspx  asp py
        dataType: "json",
        success: function (list) { //list是一个集合
            var html = "";
            list.forEach(function (item) {
                var {
                    id,
                    goodsname,
                    goodsimg,
                    goodsnum,
                    goodsprice
                } = item;
                html +=
                    ` <div class="tr">
                            <img src="${goodsimg}">
                            <p>
                                <span>${goodsname}</span>
                            </p>
                            <p>
                                <span>价格${(goodsprice*1).toFixed(2)}</span>
                                <span>数量${goodsnum}</span>
                                <span class='buy' onclick="gotomyshoppingcar('${id}')">立即购买</span>
                            </p>
                         </div>`;
            });
            content.innerHTML = html;

        },
        error: function (info) {
            console.log(info);
        }
    });

    function gotomyshoppingcar(goodsid) {
        // alert(goodsid); //session
        //加入购物车 判断用户是否登录
        var loginId = getCookie("loginId"); //获取用户登录的编号
        if (loginId) {
            //加入购物车的代码
            //人买商品  如果买过了(查询) 就更新数量(更新)  没有买过新增一条(新增)
            $.ajax({
                type: "get",
                url: "../php/gotomyshoppincar.php",
                data: {
                    userid: loginId,
                    goodsid: goodsid,
                    num: 1
                },
                dataType: "json",
                success: function (obj) {
                    if (obj["code"] == 1) {
                        //加入成功
                        if (confirm("加入成功 是否立即结算")) {
                            window.location.href = "myshoppingcarlist.html";
                        } else {
                            showNum();
                        }

                    } else {
                        alert(obj["msg"]);
                    }

                }

            });

        } else {
            //返回登录页面
            gotoLogin();
        }

    }

    function gotoLogin() {
        setCookie("backUrl", window.location.href, 7);
        window.location.href = "../html/login.html";
        // window.location.href = "login.html?backurl="+window.location.href;
    }

    function userExist() {
        setCookie("loginId", "", -1);
        setCookie("loginName", "", -1);
        gotoLogin();
    }

    function showNum() {
        $.ajax({
            type: "get",
            url: "../php/getusergoodsnum.php",
            data: {
                loginId: loginId
            },
            dataType: "json",
            success: function (obj) {
                if (obj["sum"] >= 1) {
                    shoppingInfoDiv.innerHTML = `<a href="myshoppingcarlist.html">${obj["sum"]}</a>`;
                } else {
                    shoppingInfoDiv.innerHTML = `<a>空空如也</a>`;
                }
                shoppingInfoDiv.style.display = "block";
            }
        });
    }
</script>

</html>